---
title: "Ponto5"
author: "Lucas Gelape"
date: "14/03/2018"
output: html_document
---

# 5. Representações gráficas de variáveis

```{r setup_1, include=FALSE, cache=FALSE}
require("knitr")
opts_knit$set(root.dir = '/Users/lucasgelape/Downloads/2018_ENAP/Bancos/')
```

```{r setup_2}
banco <- read.csv("banco_unido.csv", stringsAsFactors = F)
```

Outra relevante maneira de se descrever os dados se dá por meio de gráficos, que facilitam a visualização e compreensão dos leitores.

O R base possui uma série de funções para a produção de gráficos. Porém, o R também possui uma gramática poderosa para a realização de gráficos: o *ggplot*. O pacote `ggplot2` nos permite uma grande flexibilidade na realização dessas figuras, possibilitando que sejam feitos gráficos mais personalizados.

Veremos como produzir os seguintes gráficos: gráficos de barras, histogramas, boxplots e diagramas de dispersão.

## 5.1 Gráficos no R base

As funções para criação de gráficos no R base são auto explicativas. Os argumentos das funções possibilitam editar uma série de elementos do gráfico. Não nos aprofundaremos nessas possibilidades, pois pretendemos explorar o ggplot. Caso tenham interesse, a ajuda das funções é extremamente útil para explorar essas possibilidades.

Essas funções são uma boa opção para uma rápida exploração dos dados, enquanto os gráficos produzidos pelo ggplot são mais indicados para análises mais aprofundadas e apresentação para terceiros. O [guia prático de R (do Fernando Meireles, UFMG)](http://fmeireles.com/teaching/r_um_guia_pratico.html#5_gráficos) explica e exemplifica as possibilidades das funções para produção de gráficos do R base.

Abaixo, apresentaremos alguns exemplos de produção de histogramas, boxplots, gráficos de barras e diagramas de dispersão.

* Histograma

```{r rbase_1}
hist(banco$rendapc_10)
```

* Boxplot

```{r rbase_2}
boxplot(banco$rendapc_91)
```

* Gráfico de barras

É preciso chamar a atenção para o fato de que a função barplot exige que o objeto apresente a frequência de uma variável. Por isso, utilizamos as funções `table` e `prop.table` para nos apresentar a frequência (absoluta e relativa, respectivamente) do que desejamos plotar.

```{r rbase_3}
regiao <- table(banco$regiao)
barplot(regiao)

gini91 <- table(banco$gini_91)
barplot(gini91)

gini00 <- prop.table(table(banco$gini_00))
barplot(gini00)
```

* Diagrama de dispersão

```{r rbase_4}
plot(banco$rendapc_10, banco$mortalidade_10)

plot(banco$rendapc_10, banco$gini_10)
```

## 5.2 Introdução ao ggplot

```{r ggplot_1}
library(ggplot2)
```

O ggplot2 tem uma gramática comum para todos os gráficos que ele gera. Ela se inicia com a definição de qual o banco a ser utilizado

```{r ggplot_2}
ggplot(data = banco)
```

Em seguida, adicionamos camadas a nossa base, segundo os gráficos que pretendemos realizar. Cada `geom_` corresponde a um gráfico diferente. As funções `geom_` são acompanhadas de um argumento `mapping`, que nos dirá quais são as "coordenadas" do nosso "mapa", isto é, do gráfico.

## 5.2.1 Histograma

A estrutura básica de um histograma só requer a inclusão de uma camada `geom_histogram`, com a definição de qual a variável contínua de interesse.

```{r hist_1}
ggplot(data = banco) +
  geom_histogram(mapping = aes(x = rendapc_10))
```

Percebam o nome do eixo-y: count. Ele nos indica que, por padrão, o `geom_histogram` vai nos dar a contagem, ou seja, a frequência absoluta da distribuição da variável.

Para o histograma, podemos estabelecer a largura das caixas, com o argumento `binwidth`. As caixas ficarão nitidamente mais largas do que antes.

```{r hist_2}
ggplot(data = banco) +
  geom_histogram(mapping = aes(x = rendapc_10), binwidth = 100)
```

Ou então o n. de caixas que queremos observar, com o argumento `bins`. Este argumento adequa o número de caixas estabelecido à distribuição da variável.

```{r hist_3}
ggplot(data = banco) +
  geom_histogram(mapping = aes(x = rendapc_10), bins = 20)
```

Podemos incluir mais de um "histograma" no mesmo gráfico, por meio de uma espécie de gráfico de linhas, com uma camada criada com `geom_freqpoly`. Nesse caso, vamos selecionar outra variável do banco para colorir cada uma das linhas. No caso, com o argumento `color`, selecionamos a variável `regiao`.

```{r hist_4}
ggplot(data = banco) +
  geom_freqpoly(mapping = aes(x = rendapc_10, color = regiao), bins = 20)
```

Aqui, começa a ficar nítida uma diferença que veremos persistentemente: a menor renda per capita de municípios nordestinos. Vejam como eles destoam de outras regiões. Somente o Norte poderia se aproximar deste tipo de distribuição (fiquem atentos, pois ainda estamos usando a frequência absoluta como parâmetro para a produção do gráfico).

Contudo, ainda faltam muitos elementos para que o gráfico esteja "apresentável" em um relatório, artigo etc.

Ainda precisamos, por exemplo, renomear os eixos do nosso grafico, de um modo comum a todos os graficos que produziremos: com a função `labs` e os argumentos `x`, para nomear o eixo horizontal, e `y`, para nomear o eixo vertical.

```{r hist_5}
ggplot(data = banco) +
  geom_freqpoly(mapping = aes(x = rendapc_10, color = regiao), bins = 20) +
  labs(x = "Renda per capita (2010)", y = "Frequência Absoluta")
```

Podemos, com a mesma função, incluir título e legenda ao gráfico, com os argumentos `title` e `caption`.

```{r hist_6}
ggplot(data = banco) +
  geom_freqpoly(mapping = aes(x = rendapc_10, color = regiao), bins = 20) +
  labs(x = "Renda per capita (2010)", y = "Frequência Absoluta",
       title = "Distribuição da Variável - Renda per capita (2010, em R$)", 
       caption = "Elaborado pelos autores, a partir do Atlas do Desenvolvimento Humano no Brasil (2018)") 
```

Renomeamos o título da legenda, com a função `scale_colour_discrete`. Essa é uma função que vai definir as características do elemento incluído como `color`, no caso deste ser uma variável categórica. Com os argumentos desta função, podemos definir uma série de características, como cores para valores de missing, limites da escala, nome da legenda, etc. O nome da legenda é definido com o argumento `name`.

```{r hist_7}
ggplot(data = banco) +
  geom_freqpoly(mapping = aes(x = rendapc_10, color = regiao), bins = 20) +
  labs(x = "Renda per capita (2010)", y = "Frequência Absoluta",
       title = "Distribuição da Variável - Renda per capita (2010, em R$)", 
       caption = "Elaborado pelos autores, a partir do Atlas do Desenvolvimento Humano no Brasil (2018)") +
  scale_colour_discrete(name = "Região")
```

Percebam que os elementos textuais não estão centralizados no plot. Para reposicioná-los na figura, utilizamos a função `theme` e indicamos com quais elementos desejamos trabalhar. No caso, são `plot.title` (o título do gráfico) e `plot.caption` (a legenda do gráfico). Queremos mexer no texto desses elementos, portanto indicamos a função `element_text`, acompanhada do argumento `hjust`, que indica qual alinhamento desejamos (outros valores atribuídos ao argumento indicam alinhamentos à esquerda ou à direita, por exemplo).

```{r hist_8}
ggplot(data = banco) +
  geom_freqpoly(mapping = aes(x = rendapc_10, color = regiao), bins = 20) +
  labs(x = "Renda per capita (2010)", y = "Frequência Absoluta",
       title = "Distribuição da Variável - Renda per capita (2010, em R$)", 
       caption = "Elaborado pelos autores, a partir do Atlas do Desenvolvimento Humano no Brasil (2018)") +
  scale_colour_discrete(name = "Região") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.caption = element_text(hjust = 0.5))
```

Por fim, para facilitar a legibilidade do grafico, por que não tirar o fundo cinza e aumentar a espessura das linhas? Para modificar o fundo do gráfico, usamos as funções `theme_`. As variações de tema nos dão diferentes possibilidades de background para a figura (exploraremos diferentes "temas" ao longo dessa aula). Para modificar a espessura das linhas, voltamos ao nosso argumento `mapping`, e indicamos o tamanho (`size`) que desejamos atribuir a elas.

```{r hist_9}
ggplot(data = banco) +
  geom_freqpoly(mapping = aes(x = rendapc_10, color = regiao), bins = 20, size = 1.0) +
  labs(x = "Renda per capita (2010)", y = "Frequência Absoluta",
       title = "Distribuição da Variável - Renda per capita (2010, em R$)", 
       caption = "Fonte: Elaborado pelos autores, a partir do Atlas do Desenvolvimento Humano no Brasil (2018)") +
  scale_colour_discrete(name = "Região") +
  theme_light() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.caption = element_text(hjust = 0.5))
```

Para exportar o gráfico, podemos usar a função `ggsave`. Ela nos dá a opção de salvar o plot em diferentes
formatos e qualidade de imagem. No caso, vamos exportá-lo em formato .png de 300 dpi.

```{r hist_10, eval=FALSE}
ggsave("histograma.png", dpi = 300)
```

A partir do histograma, foi possível explorar diversas das potencialidades oferecidas pelo `ggplot2`. Nos próximos gráficos continuaremos vendo outras opções.

## 5.2 Boxplot

Para fazer um boxplot de uma única variavel com o ggplot, uma boa opção é especificar o `x` das `aesthetics` do nosso "mapa" como `factor(0)`.

```{r boxplot_1}
ggplot(data = banco) +
  geom_boxplot(mapping = aes(x = factor(0), y = rendapc_10))
```

O boxplot no ggplot facilita bastante a comparação entre grupos. Este uso pode ser bastante produtivo. Vamos aqui compara a distribuição da variável renda *per capita* em 2010, segundo as regiões do país. Para tanto, precisamos especificar como `x` a variável categórica de interesse e como `y` a variável contínua cuja distribuição desejamos observar.

```{r boxplot_2}
ggplot(data = banco) +
  geom_boxplot(mapping = aes(x = regiao, y = rendapc_10))
```

Observamos aqui algo semelhante ao que o histograma nos sugeria: uma semelhança entre as regiões Norte e Nordeste, e suas aparentes diferenças para as demais regiões.

Esse tipo de visualização funciona até mesmo para variáveis categóricas com muitos grupos. Troquemos as regiões do país pelas unidades da federação.

```{r boxplot_3}
ggplot(data = banco) +
  geom_boxplot(mapping = aes(x = uf, y = rendapc_10))
```

Para finalizar a produção do gráfico, vamos adicionar e formatar outros elementos: nomes nos eixos, título, legenda, alinhamento do texto e tema (fundo). Perceba que agora usaremos `theme_classic` e não `theme_light`.

```{r}
ggplot(data = banco) +
  geom_boxplot(mapping = aes(x = regiao, y = rendapc_10)) + 
  labs(x = "Região", y = "Renda per capita (2010)",
       title = "Boxplots da variável Renda per capita (2010), segundo a região", 
       caption = "Fonte: Elaborado pelos autores, a partir do Atlas do Desenvolvimento Humano no Brasil (2018)") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.caption = element_text(hjust = 0.5))
```

Não se esqueçam da função `ggsave` para exportá-lo! Um lembrete: a não ser que um caminho diferente seja especificado, o arquivo da imagem do gráfico será salvo em nosso diretório de trabalho.

```{r, eval=FALSE}
ggsave("boxplot.png", dpi = 300)
```

## 5.2.3 Gráficos de barras

Por padrão, o gráfico de barras apresenta a contagem de casos em cada um dos grupos da variável categórica escolhida. Trabalharemos aqui com a variável de faixas para o índice de Gini em 2010, que criamos anteriormente (a `gini_10_cat`).

```{r bar_1}
ggplot(data = banco) +
  geom_bar(mapping = aes(x = gini_10_cat))
```

Podemos incluir outros elementos, como cores para apresentar quais regiões são mais relevantes em cada categoria da variável.

```{r bar_2}
ggplot(data = banco) +
  geom_bar(mapping = aes(x = gini_10_cat, fill = regiao))
```

Vamos mudar as cores. Anteriormente, vimos que podemos manipular cores com a função `scale_colour_discrete`. Contudo, para colorirmos este gráfico, utilizamos o argumento `fill` (de preenchimento). Sendo assim, a função que usaremos é a `scale_fill_manual`, que nos permite incluir manualmente as cores que desejamos, com o argumento `values`. O R possui uma ampla lista de cores, que pode ser vista [neste link](http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf).

```{r bar_3}
ggplot(data = banco) +
  geom_bar(mapping = aes(x = gini_10_cat, fill = regiao)) +
  scale_fill_manual(values = c("blue", "yellow", "red", "orange", "green"))
```

Essas cores ficaram muito feias... Uma boa opção para a escolha de diversas cores num gráfico é o uso de paletas de cores. O ggplot nos permite utilizar paletas de cores do pacote `RColorBrewer`. Ele nos dá paletas de cores sequenciais, qualitativas e divergentes - [o slide 4 da apresentação linkada apresenta essas paletas](https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/colorPaletteCheatsheet.pdf). Caso vocês tenham dúvidas sobre qual paleta é a ideal, esta série de posts no R Bloggers (em inglês) [introduzem](https://www.r-bloggers.com/choosing-colour-palettes-part-i-introduction/) e [ajudam a selecionar](https://www.r-bloggers.com/choosing-colour-palettes-part-ii-educated-choices/) paletas de cores no R.

```{r bar_4}
ggplot(data = banco) +
  geom_bar(mapping = aes(x = gini_10_cat, fill = regiao)) +
  scale_fill_brewer(palette = "Accent")
```

Opa, a escala da variável está confusa: alta, baixa, média? O mais lógico não seria: baixa, média, alta? Utilizando a função `scale_x_discrete` podemos alterar o nosso eixo-x. Para alterar a ordem das categorias, podemos usar o argumento `limits` e apontar a ordem das categorias (cuidado: o nome entre `" "` deve ser idêntico ao "valor" da categoria no banco).

```{r bar_5}
ggplot(data = banco) +
  geom_bar(mapping = aes(x = gini_10_cat, fill = regiao)) +
  scale_fill_brewer(palette = "Accent") +
  scale_x_discrete(limits = c("Baixa", "Media", "Alta"))
```

E, por fim, corrigimos, adicionamos os elementos textuais e fazemos outras modificações para finalizar o gráfico. Vejam que agora utilizamos o `theme_minimal` para o fundo da imagem. (Não incluirei mais o `ggsave` neste documento, mas não se esqueçam de usá-lo, caso desejem exportar o gráfico como arquivo de imagem!)

```{r bar_6}
ggplot(data = banco) +
  geom_bar(mapping = aes(x = gini_10_cat, fill = regiao)) +
  scale_fill_brewer(palette = "Accent", name = "Região") +
  scale_x_discrete(limits = c("Baixa", "Media", "Alta")) +
  labs(x = "Categorias do Índice de Gini", y = "N. de municípios",
     title = "Número de municípios segundo seu nível de desigualdade (1991)", 
     caption = "Fonte: Elaborado pelos autores, a partir do Atlas do Desenvolvimento Humano no Brasil (2018)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.caption = element_text(hjust = 0.5))
```

## 5.2.4 Diagramas de Dispersão

Como visto no curso, os diagramas de dispersão são gráficos usados para visualizar as observações de duas variáveis contínuas (apesar de ser possível utilizá-lo também para visualização de variáveis categóricas, o que não é comum). Ou seja, para usarmos o `geom_point`, precisamos especificar o `x` e o `y` em nosso `aes`.

```{r dispersao_1}
ggplot(data = banco) +
  geom_point(mapping = aes(x = rendapc_10, y = mortalidade_10))
```

Uma facilidade do ggplot é permite que a transformação de dados por meio de funções diretamente no seu código. No caso, vamos utilizar o log da renda per capita para melhor visualização e interpretação dos dados.

```{r dispersao_2}
ggplot(data = banco) +
  geom_point(mapping = aes(x = log(rendapc_10), y = mortalidade_10))
```

O gráfico ainda está bastante poluído, por causa do grande número de pontos. Reduzir o tamanho deles talvez ajude. Assim como para as linhas do nosso `geom_freqpoly`, podemos usar o argumento `size` para modificar o tamanho dos elementos do nosso gráfico `geom_point`.

```{r dispersao_3}
ggplot(data = banco) +
  geom_point(mapping = aes(x = log(rendapc_10), y = mortalidade_10), 
             size = 0.5)
```

Tambám podemos tanto colorir quanto mudar o formato dos pontos, segundo um parâmetro estabelecido a partir de uma variável categórica. No caso, a mudanca de formato (utilizando o argumento `shape`) será de difícil percepção, devido ao tamanho das figuras.

```{r dispersao_4}
ggplot(data = banco) +
  geom_point(mapping = aes(x = log(rendapc_10), y = mortalidade_10,
                           shape = regiao), size = 0.5)
```

Vamos tentar então a cor, usando o argumento `color`.

```{r dispersao_5}
ggplot(data = banco) +
  geom_point(mapping = aes(x = log(rendapc_10), y = mortalidade_10,
                           color = regiao), size = 0.5)
```

Vejam como as cores nos revelam um interessante padrão: a mortalidade parece maior no Norte e Nordeste, conjugada com a renda per capita menor dessas regiões.

Podemos ainda adicionar uma linha que indique a "relação" entre as variáveis. No caso, uma reta da regressão linear de um modelo utilizando as duas variáveis (com o argumento `geom_smooth`).

```{r dispersao_6}
ggplot(data = banco, aes(x = log(rendapc_10), y = mortalidade_10)) +
  geom_point(mapping = aes(color = regiao), size = 0.5) +
  geom_smooth(method = "lm", color = "black")
```

Agora podemos adicionar os elementos textuais do gráfico, para finalizá-lo (utilizamos outro tema diferente, o `theme_bw`).

```{r dispersao_7}
ggplot(data = banco) +
  geom_point(mapping = aes(x = log(rendapc_10), y = mortalidade_10,
                           color = regiao), size = 0.5) +
  labs(x = "Log da Renda per capita (2010)", y = "Mortalidade Infantil (2010)",
     title = "Log da Renda per capita x Mortalidade Infantil (2010)", 
     caption = "Fonte: Elaborado pelos autores, a partir do Atlas do Desenvolvimento Humano no Brasil (2018)") +
  scale_color_discrete(name = "Região") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.caption = element_text(hjust = 0.5))
```

# Resumo do conteúdo trabalhado:

* Na parte final do nosso curso, vimos como produzir representacoes gráficas no R, por meio de funções do R base e do ggplot.

* As funções do R base são simples e úteis para rápidas visualizações dos dados.

* O ggplot nos apresenta uma ampla potencialidade na produção de graficos, permitindo a inclusão de mais informações, com visualizações mais amigáveis para o leitor.

* Aprendemos a criar os seguintes gráficos: 

    * histogramas;
    * boxplots;
    * gráficos de barras;
    * diagramas de dispersão.

Existem outros gráficos que podem ser produzidos. Explorar as potencialidades do ggplot pode ser bastante produtivo (e divertido)!

Terminamos nosso curso com a [prática 5](), mas sigo a disposição de tod@s para a resolução de quaisquer dúvidas. Sintam-se a vontade para entrar em contato (pessoalmente ou por e-mail).

Obrigado a tod@s!

